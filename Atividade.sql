-- ========= 1. CLIENTES =========
CREATE TABLE Clientes (
    ID_Cliente NUMBER GENERATED BY DEFAULT AS IDENTITY,
    Nome VARCHAR2(150) NOT NULL,
    Email VARCHAR2(100) NOT NULL,
    CPF VARCHAR2(11) NOT NULL,
    Data_Nascimento DATE,
    Data_Cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT pk_clientes PRIMARY KEY (ID_Cliente),
    CONSTRAINT uq_clientes_email UNIQUE (Email),
    CONSTRAINT uq_clientes_cpf UNIQUE (CPF)
);

-- ========= 2. FORMAS DE PAGAMENTO =========
CREATE TABLE Formas_Pagamento (
    ID_Forma_Pagamento NUMBER GENERATED BY DEFAULT AS IDENTITY,
    ID_Cliente NUMBER NOT NULL,
    Tipo VARCHAR2(20) NOT NULL,
    Descricao VARCHAR2(100),
    Ativo NUMBER(1) DEFAULT 1 NOT NULL,
    CONSTRAINT pk_formas_pagamento PRIMARY KEY (ID_Forma_Pagamento),
    CONSTRAINT fk_formas_pag_cliente FOREIGN KEY (ID_Cliente)
        REFERENCES Clientes(ID_Cliente) ON DELETE CASCADE,
    CONSTRAINT chk_formas_pag_tipo CHECK (Tipo IN ('CARTAO_CREDITO', 'PIX', 'BOLETO', 'CONTA_BANCARIA')),
    CONSTRAINT chk_formas_pag_ativo CHECK (Ativo IN (0, 1))
);

-- ========= 3. CARTÕES =========
CREATE TABLE Cartoes (
    ID_Cartao NUMBER GENERATED BY DEFAULT AS IDENTITY,
    ID_Forma_Pagamento NUMBER NOT NULL,
    Nome_Titular VARCHAR2(150) NOT NULL,
    Numero_Ultimos_4_Digitos VARCHAR2(4) NOT NULL,
    Data_Validade DATE NOT NULL,
    Bandeira VARCHAR2(30),
    CONSTRAINT pk_cartoes PRIMARY KEY (ID_Cartao),
    CONSTRAINT uq_cartoes_forma_pag UNIQUE (ID_Forma_Pagamento),
    CONSTRAINT fk_cartoes_forma_pag FOREIGN KEY (ID_Forma_Pagamento)
        REFERENCES Formas_Pagamento(ID_Forma_Pagamento) ON DELETE CASCADE
);

-- ========= 4. FATURAS =========
-- CORREÇÃO: Removido 'ON DELETE RESTRICT'
CREATE TABLE Faturas (
    ID_Fatura NUMBER GENERATED BY DEFAULT AS IDENTITY,
    ID_Cartao NUMBER NOT NULL,
    Valor_Total NUMBER(12, 2) DEFAULT 0 NOT NULL,
    Data_Vencimento DATE NOT NULL,
    Data_Fechamento DATE NOT NULL,
    Status VARCHAR2(15) DEFAULT 'ABERTA' NOT NULL,
    CONSTRAINT pk_faturas PRIMARY KEY (ID_Fatura),
    CONSTRAINT fk_faturas_cartao FOREIGN KEY (ID_Cartao)
        REFERENCES Cartoes(ID_Cartao), -- <-- CORRIGIDO AQUI
    CONSTRAINT chk_faturas_status CHECK (Status IN ('ABERTA', 'FECHADA', 'PAGA'))
);

-- ========= 5. TRANSAÇÕES =========
-- CORREÇÃO: Removido 'ON DELETE RESTRICT'
CREATE TABLE Transacoes (
    ID_Transacao NUMBER GENERATED BY DEFAULT AS IDENTITY,
    ID_Forma_Pagamento NUMBER NOT NULL,
    ID_Fatura NUMBER,
    Valor NUMBER(12, 2) NOT NULL,
    Data_Transacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    Descricao VARCHAR2(200),
    Status VARCHAR2(15) DEFAULT 'PENDENTE' NOT NULL,
    CONSTRAINT pk_transacoes PRIMARY KEY (ID_Transacao),
    CONSTRAINT fk_transacoes_forma_pag FOREIGN KEY (ID_Forma_Pagamento)
        REFERENCES Formas_Pagamento(ID_Forma_Pagamento), -- <-- CORRIGIDO AQUI
    CONSTRAINT fk_transacoes_fatura FOREIGN KEY (ID_Fatura)
        REFERENCES Faturas(ID_Fatura) ON DELETE SET NULL,
    CONSTRAINT chk_transacoes_status CHECK (Status IN ('APROVADA', 'NEGADA', 'PENDENTE', 'ESTORNADA'))
);

-- DADO 1: Ana Silva
-- Cenário: Uma cliente com 1 cartão de crédito, 1 fatura e 1 transação nesse cartão.

-- 1. Criar a Cliente (Ela receberá o ID_Cliente = 1)
INSERT INTO Clientes (Nome, Email, CPF, Data_Nascimento)
VALUES ('Ana Silva', 'ana.silva@email.com', '11122233344', TO_DATE('1990-05-15', 'YYYY-MM-DD'));

-- 2. Criar a Forma de Pagamento (Cartão) para a Ana (ID_Cliente = 1)
-- (Esta forma de pagamento receberá o ID_Forma_Pagamento = 1)
INSERT INTO Formas_Pagamento (ID_Cliente, Tipo, Descricao)
VALUES (1, 'CARTAO_CREDITO', 'Cartão Visa Final 4321');

-- 3. Criar os detalhes do Cartão (ID_Forma_Pagamento = 1)
-- (Este cartão receberá o ID_Cartao = 1)
INSERT INTO Cartoes (ID_Forma_Pagamento, Nome_Titular, Numero_Ultimos_4_Digitos, Data_Validade, Bandeira)
VALUES (1, 'ANA R SILVA', '4321', TO_DATE('2028-12-01', 'YYYY-MM-DD'), 'Visa');

-- 4. Criar uma Fatura para esse Cartão (ID_Cartao = 1)
-- (Esta fatura receberá o ID_Fatura = 1)
INSERT INTO Faturas (ID_Cartao, Data_Vencimento, Data_Fechamento, Status)
VALUES (1, TO_DATE('2025-11-10', 'YYYY-MM-DD'), TO_DATE('2025-11-01', 'YYYY-MM-DD'), 'ABERTA');

-- 5. Criar uma Transação nessa Fatura (ID_Forma_Pagamento = 1, ID_Fatura = 1)
INSERT INTO Transacoes (ID_Forma_Pagamento, ID_Fatura, Valor, Descricao, Status)
VALUES (1, 1, 150.75, 'Compra iFood', 'APROVADA');

--------------------------------------------------------------------------------

-- DADO 2: Bruno Costa
-- Cenário: Um cliente com 1 cartão de crédito, 1 fatura e 2 transações nessa fatura.

-- 1. Criar o Cliente (Ele receberá o ID_Cliente = 2)
INSERT INTO Clientes (Nome, Email, CPF, Data_Nascimento)
VALUES ('Bruno Costa', 'bruno.c@email.com', '55566677788', TO_DATE('1985-01-20', 'YYYY-MM-DD'));

-- 2. Criar a Forma de Pagamento (Cartão) para o Bruno (ID_Cliente = 2)
-- (Esta forma de pagamento receberá o ID_Forma_Pagamento = 2)
INSERT INTO Formas_Pagamento (ID_Cliente, Tipo, Descricao)
VALUES (2, 'CARTAO_CREDITO', 'Cartão Master Final 9876');

-- 3. Criar os detalhes do Cartão (ID_Forma_Pagamento = 2)
-- (Este cartão receberá o ID_Cartao = 2)
INSERT INTO Cartoes (ID_Forma_Pagamento, Nome_Titular, Numero_Ultimos_4_Digitos, Data_Validade, Bandeira)
VALUES (2, 'BRUNO G COSTA', '9876', TO_DATE('2027-06-01', 'YYYY-MM-DD'), 'Mastercard');

-- 4. Criar uma Fatura para esse Cartão (ID_Cartao = 2)
-- (Esta fatura receberá o ID_Fatura = 2)
INSERT INTO Faturas (ID_Cartao, Data_Vencimento, Data_Fechamento, Status)
VALUES (2, TO_DATE('2025-11-15', 'YYYY-MM-DD'), TO_DATE('2025-11-05', 'YYYY-MM-DD'), 'ABERTA');

-- 5. Criar DUAS Transações nessa Fatura (ID_Forma_Pagamento = 2, ID_Fatura = 2)
INSERT INTO Transacoes (ID_Forma_Pagamento, ID_Fatura, Valor, Descricao, Status)
VALUES (2, 2, 85.00, 'Uber Viagem', 'APROVADA');

INSERT INTO Transacoes (ID_Forma_Pagamento, ID_Fatura, Valor, Descricao, Status)
VALUES (2, 2, 320.00, 'Supermercado', 'APROVADA');

--------------------------------------------------------------------------------

-- DADO 3: Carla Dias
-- Cenário: Uma cliente que só usa PIX. Ela não tem cartão nem fatura.

-- 1. Criar a Cliente (Ela receberá o ID_Cliente = 3)
INSERT INTO Clientes (Nome, Email, CPF, Data_Nascimento)
VALUES ('Carla Dias', 'carla.dias@email.com', '99988877766', TO_DATE('2000-02-10', 'YYYY-MM-DD'));

-- 2. Criar a Forma de Pagamento (PIX) para a Carla (ID_Cliente = 3)
-- (Esta forma de pagamento receberá o ID_Forma_Pagamento = 3)
INSERT INTO Formas_Pagamento (ID_Cliente, Tipo, Descricao)
VALUES (3, 'PIX', 'Chave PIX (Email)');

-- 3. Criar uma Transação PIX (ID_Forma_Pagamento = 3, ID_Fatura = NULL)
-- (Note que esta transação não tem cartão nem fatura associados)
INSERT INTO Transacoes (ID_Forma_Pagamento, ID_Fatura, Valor, Descricao, Status)
VALUES (3, NULL, 50.00, 'Pagamento Lanchonete', 'APROVADA');

SELECT * FROM clientes;